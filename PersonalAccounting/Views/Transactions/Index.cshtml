@model List<PersonalAccounting.ViewModels.TransactionViewModel>
@{
    ViewData["Title"] = "تراکنش‌ها";
}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>تراکنش‌ها</h3>
    <button class="btn btn-primary" id="btnCreate" data-url="@Url.Action("Create")"><i class="fa fa-plus"></i> افزودن</button>
</div>

<div class="card mb-3">
    <div class="card-body row g-2 align-items-end">
        <div class="col-md-3">
            <label class="form-label">نوع</label>
            <select id="filterType" class="form-select">
                <option value="">همه</option>
                <option value="Income">درآمد</option>
                <option value="Expense">هزینه</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">دسته‌بندی</label>
            <select id="filterCategory" class="form-select">
                <option value="">همه</option>
                @foreach (var c in (SelectList)ViewBag.Categories)
                {
                    <option value="@c.Value">@c.Text</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">از تاریخ</label>
            <input id="filterFrom" class="form-control persian-date" />
        </div>
        <div class="col-md-3">
            <label class="form-label">تا تاریخ</label>
            <input id="filterTo" class="form-control persian-date" />
        </div>
        <div class="col-12 mt-2">
            <button id="btnApplyFilters" class="btn btn-outline-primary">اعمال فیلتر</button>
            <button id="btnResetFilters" class="btn btn-outline-secondary">بازنشانی</button>
        </div>
    </div>
</div>

<table id="transactionsTable" class="table table-striped table-bordered align-middle" style="width:100%">
    <thead>
        <tr>
            <th>شرح</th>
            <th>نوع</th>
            <th>مبلغ</th>
            <th>تاریخ</th>
            <th>دسته‌بندی</th>
            <th style="width:120px">عملیات</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model)
    {
        <tr data-id="@item.Id">
            <td>@item.Description</td>
            <td>@(item.Type == PersonalAccounting.Models.TransactionType.Income ? "درآمد" : "هزینه")</td>
            <td class="text-end">@item.Amount.ToString("N0")</td>
            <td>@item.PersianDate</td>
            <td>@item.CategoryName</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-info btn-details" data-url="@Url.Action("Details", new { id = item.Id })"><i class="fa fa-eye"></i></button>
                    <button class="btn btn-outline-warning btn-edit" data-url="@Url.Action("Edit", new { id = item.Id })"><i class="fa fa-pen"></i></button>
                    <button class="btn btn-outline-danger btn-delete" data-url="@Url.Action("Delete", new { id = item.Id })"><i class="fa fa-trash"></i></button>
                </div>
            </td>
        </tr>
    }
    </tbody>
</table>

@section Scripts{
<script>
$(function(){
    const table = new DataTable('#transactionsTable', {
        language: { url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/fa.json' },
        pageLength: 10,
        ordering: true
    });

    $('.persian-date').persianDatepicker({
        initialValue: false,
        format: 'YYYY/MM/DD'
    });

    $('#btnApplyFilters').on('click', function(){
        const type = $('#filterType').val();
        const cat = $('#filterCategory').val();
        const from = $('#filterFrom').val();
        const to = $('#filterTo').val();
        const url = '@Url.Action("Index")' + `?type=${type}&categoryId=${cat}&fromPersianDate=${from}&toPersianDate=${to}`;
        window.location = url;
    });
    $('#btnResetFilters').on('click', function(){ window.location = '@Url.Action("Index")'; });

    function openModal(url, title){
        $('#modalContainer .modal-title').text(title);
        $('#modalContainer .modal-body').load(url, function(){
            const modal = new bootstrap.Modal(document.getElementById('modalContainer'));
            modal.show();
        });
    }

    $('#btnCreate').on('click', function(){ openModal($(this).data('url'), 'ایجاد تراکنش'); });
    $('#transactionsTable').on('click', '.btn-edit', function(){ openModal($(this).data('url'), 'ویرایش تراکنش'); });
    $('#transactionsTable').on('click', '.btn-details', function(){ openModal($(this).data('url'), 'جزئیات تراکنش'); });
    $('#transactionsTable').on('click', '.btn-delete', function(){ openModal($(this).data('url'), 'حذف تراکنش'); });
});
</script>
}